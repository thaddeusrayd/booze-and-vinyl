<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Booze &amp; Vinyl</title>
</head>
<body>
  <h1>Booze &amp; Vinyl</h1>
  <p>Welcome to the Booze &amp; Vinyl app!</p>

  <h2>Want to contribute?</h2>
  <p id="mostNeeded">Loading…</p>

  <h3>Other ingredients by order of need:</h3>
  <p id="ingredients"></p>

  <form id="contributionForm">
    <label for="ingredient"></label>
    <input type="radio" name="ingredient" value="Lime Juice" /> Lime Juice<br />
    <input type="radio" name="ingredient" value="Mezcal" /> Mezcal<br />
    <input type="radio" name="ingredient" value="Aperol" /> Aperol<br />
    <input type="radio" name="ingredient" value="Genepy" /> Genepy<br />

    <label for="amount"
      >Amount (if bringing fresh limes, assume 1 oz per lime):</label
    ><br />
    <input type="number" id="amount" name="amount" min="0" /><br />

    <label for="unit">Unit:</label>
    <input type="radio" name="unit" value="oz" /> oz
    <input type="radio" name="unit" value="ml" /> ml<br />

    <button type="button" onclick="updateIngredientList()">Submit Contribution</button>
  </form>

  <script type="text/javascript">
    // --- state ---
    let ingredients = []; // populated after first fetch

    // --- helpers ---

    // non‑mutating rank
    function rankIngredients(list) {
      return [...list].sort(
        (a, b) => a.amountAcquired / a.amountNeeded - b.amountAcquired / b.amountNeeded
      );
    }

    // single render pass
    function render(list) {
      if (!list.length) return;

      const [mostNeeded, ...others] = rankIngredients(list);

      document.getElementById("mostNeeded").textContent =
        `Most needed ingredient: ${mostNeeded.ingredient}`;

      document.getElementById("ingredients").innerHTML = others
        .map((i) => i.ingredient)
        .join("<br>");
    }

    // --- API calls ---

    async function fetchIngredients() {
      try {
        const res = await fetch("http://localhost:3000/ingredients");
        ingredients = await res.json();
        render(ingredients);
      } catch (err) {
        console.error(err);
        document.getElementById("mostNeeded").textContent = "Error loading data";
      }
    }

    async function updateIngredientList() {
      const ingredient = document.querySelector('input[name="ingredient"]:checked')?.value;
      const unit = document.querySelector('input[name="unit"]:checked')?.value;
      const amount = document.getElementById("amount").value;

      if (!ingredient || !unit || !amount) {
        alert("Please select an ingredient, unit, and amount.");
        return;
      }

      const ozAmount = unit === "ml" ? amount / 29.5735 : Number(amount);

      try {
        const res = await fetch("http://localhost:3000/contributions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ingredient, ozAmount }),
        });

        if (!res.ok) {
          alert("Server said: " + (await res.text()));
          return;
        }

        await fetchIngredients(); // re-render with fresh data
        document.getElementById("contributionForm").reset();
        alert(`Thanks for bringing ${amount} ${unit} of ${ingredient}!`);
      } catch (err) {
        console.error(err);
        alert("Network error—check console for details.");
      }
    }

    // --- kick off ---
    fetchIngredients();
  </script>
</body>
</html>
